package fi.lbd.mobile.repository;

import android.util.Log;

import com.fasterxml.jackson.core.JsonParseException;

import org.json.JSONArray;
import org.json.JSONException;

import java.io.IOException;
import java.util.List;

import fi.lbd.mobile.LBDApplication;
import fi.lbd.mobile.mapobjects.MapObject;
import fi.lbd.mobile.mapobjects.PointLocation;

/**
 * Handles the map objects. Fetches the objects from backend service if required.
 *
 * Created by tommi on 19.10.2014.
 */
public class MapObjectRepository {
    // TODO: Tartteeko jotain spatiaalista cachea? http://www.geotools.org/ tai joku vastaava

	private static final String tempContents = "[{\"OD_data\": {\"geometry_name\": \"GEOLOC\", \"geometry\": {\"type\": \"Point\", \"coordinates\": [23.79485698869311, 61.50460698965098]}, \"feature_id\": \"WFS_KATUVALO.385517\", \"_id\": {\"$oid\": \"543cd02915040d2c248286f7\"}, \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800864\", \"LAMPPU_TYYPPI_KOODI\": \"100991\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 385517, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"TYYPPI\": \"Hg_125W ELOHOPEALAMPPU\"}}, \"MetaData\": {}, \"OD_info\": {\"identifier_field_name\": \"feature_id\"}}, {\"OD_data\": {\"geometry_name\": \"GEOLOC\", \"geometry\": {\"type\": \"Point\", \"coordinates\": [23.795944666699963, 61.50414388252429]}, \"feature_id\": \"WFS_KATUVALO.380904\", \"_id\": {\"$oid\": \"543cd04715040d2c24829509\"}, \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_7933809\", \"LAMPPU_TYYPPI_KOODI\": \"100309\", \"TYYPPI_KOODI\": \"105004\", \"KATUVALO_ID\": 380904, \"LAMPPU_TYYPPI\": \"SC 50 (SITECO)\", \"TYYPPI\": \"Sp-Na_70W SUURPAINENATRIUM\"}}, \"MetaData\": {}, \"OD_info\": {\"identifier_field_name\": \"feature_id\"}}, {\"OD_data\": {\"geometry_name\": \"GEOLOC\", \"geometry\": {\"type\": \"Point\", \"coordinates\": [23.794550107729926, 61.50349638615375]}, \"feature_id\": \"WFS_KATUVALO.383914\", \"_id\": {\"$oid\": \"543cd06015040d2c2482a0b2\"}, \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800792\", \"LAMPPU_TYYPPI_KOODI\": \"100991\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 383914, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"TYYPPI\": \"Hg_125W ELOHOPEALAMPPU\"}}, \"MetaData\": {}, \"OD_info\": {\"identifier_field_name\": \"feature_id\"}}, {\"OD_data\": {\"geometry_name\": \"GEOLOC\", \"geometry\": {\"type\": \"Point\", \"coordinates\": [23.795338124987868, 61.504624152265954]}, \"feature_id\": \"WFS_KATUVALO.385516\", \"_id\": {\"$oid\": \"543cd07415040d2c2482aa29\"}, \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800862\", \"LAMPPU_TYYPPI_KOODI\": \"100991\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 385516, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"TYYPPI\": \"Hg_125W ELOHOPEALAMPPU\"}}, \"MetaData\": {}, \"OD_info\": {\"identifier_field_name\": \"feature_id\"}}]";

    private static final String tempContents2 = "{\"totalFeatures\": 21, \"type\": \"FeatureCollection\", \"features\": [{\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.795340402819683, 61.50410995713492]}, \"id\": \"WFS_KATUVALO.380903\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_7933810\", \"TYYPPI_KOODI\": \"105004\", \"KATUVALO_ID\": 380903, \"LAMPPU_TYYPPI\": \"SC 50 (SITECO)\", \"LAMPPU_TYYPPI_KOODI\": \"100309\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.794629984705285, 61.5041767530574]}, \"id\": \"WFS_KATUVALO.380902\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_7933811\", \"TYYPPI_KOODI\": \"105004\", \"KATUVALO_ID\": 380902, \"LAMPPU_TYYPPI\": \"SC 50 (SITECO)\", \"LAMPPU_TYYPPI_KOODI\": \"100309\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.794685922038948, 61.50354783870089]}, \"id\": \"WFS_KATUVALO.381575\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_7933796\", \"TYYPPI_KOODI\": \"105004\", \"KATUVALO_ID\": 381575, \"LAMPPU_TYYPPI\": \"SC 50 (SITECO)\", \"LAMPPU_TYYPPI_KOODI\": \"100309\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.795199257764725, 61.503697166613755]}, \"id\": \"WFS_KATUVALO.381029\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_7933797\", \"TYYPPI_KOODI\": \"105004\", \"KATUVALO_ID\": 381029, \"LAMPPU_TYYPPI\": \"SC 50 (SITECO)\", \"LAMPPU_TYYPPI_KOODI\": \"100309\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.795684045279902, 61.50380424552357]}, \"id\": \"WFS_KATUVALO.381017\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_7933798\", \"TYYPPI_KOODI\": \"105004\", \"KATUVALO_ID\": 381017, \"LAMPPU_TYYPPI\": \"SC 50 (SITECO)\", \"LAMPPU_TYYPPI_KOODI\": \"100309\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.795094529701927, 61.5028563582232]}, \"id\": \"WFS_KATUVALO.381191\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3801832\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 381191, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.79481622611574, 61.50280984471178]}, \"id\": \"WFS_KATUVALO.381192\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3801834\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 381192, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.79464838235398, 61.50299951163578]}, \"id\": \"WFS_KATUVALO.381278\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3801836\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 381278, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.794454199861732, 61.5032227198506]}, \"id\": \"WFS_KATUVALO.381279\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3801838\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 381279, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.79448425499099, 61.50422676516984]}, \"id\": \"WFS_KATUVALO.383917\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800802\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 383917, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.794290012068057, 61.50345796128236]}, \"id\": \"WFS_KATUVALO.384006\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3801840\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 384006, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.795476512039656, 61.50317851146932]}, \"id\": \"WFS_KATUVALO.381071\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800760\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 381071, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.79489749075714, 61.50319092750138]}, \"id\": \"WFS_KATUVALO.381072\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800762\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 381072, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.794715828892585, 61.50329535885883]}, \"id\": \"WFS_KATUVALO.381274\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800790\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 381274, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.79448988811057, 61.50372873468845]}, \"id\": \"WFS_KATUVALO.383915\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800794\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 383915, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.79449751542243, 61.50398481140181]}, \"id\": \"WFS_KATUVALO.383916\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800796\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 383916, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.794884457760315, 61.50308690440484]}, \"id\": \"WFS_KATUVALO.381075\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800798\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 381075, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.79485698869311, 61.50460698965098]}, \"id\": \"WFS_KATUVALO.385517\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800864\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 385517, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.795944666699963, 61.50414388252429]}, \"id\": \"WFS_KATUVALO.380904\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_7933809\", \"TYYPPI_KOODI\": \"105004\", \"KATUVALO_ID\": 380904, \"LAMPPU_TYYPPI\": \"SC 50 (SITECO)\", \"LAMPPU_TYYPPI_KOODI\": \"100309\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.794550107729926, 61.50349638615375]}, \"id\": \"WFS_KATUVALO.383914\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800792\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 383914, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}, {\"geometry\": {\"type\": \"Point\", \"coordinates\": [23.795338124987868, 61.504624152265954]}, \"id\": \"WFS_KATUVALO.385516\", \"type\": \"Feature\", \"properties\": {\"NIMI\": \"XPWR_3800862\", \"TYYPPI_KOODI\": \"105001\", \"KATUVALO_ID\": 385516, \"LAMPPU_TYYPPI\": \"Ei m\\u00e4\\u00e4ritelty (TUNTEMATON)\", \"LAMPPU_TYYPPI_KOODI\": \"100991\"}, \"geometry_name\": \"GEOLOC\"}]}";

    // TODO: Saisko staticeiks? Vois thread poolilla rinnakkaistaa...
	public List<MapObject> getObjectsNearLocation(PointLocation location) {
		//String url = "http://api-lbdserver.rhcloud.com/locationdata/api/Streetlights/near/?latitude=23.795199257764725&longitude=61.503697166613755";
        //String url = "http://api-lbdserver.rhcloud.com/locationdata/api/Streetlights/near/?latitude="+location.getLatitude()+"&longitude="+location.getLongitude();
        String url = "http://lbdbackend.ignorelist.com/locationdata/api/Streetlights/near/?latitude="+location.getLatitude()+"&longitude="+location.getLongitude();
		String contents = URLReader.get(url);
        //String contents = LBDApplication.testData;
        Log.e("MapObjectRepository", "URL: "+ url );
        Log.e("MapObjectRepository", "contents: "+ contents );
		try {
            return MapObjectParser.parseCollection(contents);
            //return MapObjectParser.parseCollection(tempContents2);
			//return MapObjectParser.parseArrayOfObjects(new JSONArray(contents));
            //return MapObjectParser.parseArrayOfObjects(new JSONArray(contents));

        // TODO: Mitä näistä tarttee enää?
		//} catch (JSONException e) {
		//	// TODO Auto-generated catch block
		//	e.printStackTrace();
		} catch (JsonParseException e){

        } catch (IOException e){

        }
        // TODO: Finally lohkoon streamien sulkemiset
        return null;
	}
	

}
